<!doctype html><html lang=zh-ch><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Android安装Linux环境 | 蛙二的思考</title><meta property="og:title" content="Android安装Linux环境 - 蛙二的思考"><meta property="og:type" content="article"><meta property="article:published_time" content="2019-02-15T12:00:00+08:00"><meta property="article:modified_time" content="2019-02-15T12:00:00+08:00"><meta name=Keywords content><meta name=description content="Android安装Linux环境"><meta name=author content><meta property="og:url" content="/post/190215/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href>蛙二的思考</a></div><div><nav id=nav-menu class=clearfix><a class=current href>首页</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Android安装Linux环境</h1></header><date class="post-meta meta-date">2019年2月15日</date><div class=post-content><p>15年时试用过kbox，毕竟是个半成品，到2019年2月，安卓跑终端已经很成熟了。和Linux比，安卓的模拟环境是单用户且用户名已预置，在4.2以前，用户名就是个序号，4.2之后扩充形成类似<code>u0_a99</code>的命名方式，但本质还是单用户，且没有密码。home目录下不会再有子目录，自然不能创建新用户。</p><p>已经root可以用linux deploy。这个软件会在/dev/block/loop0（或loop1）块设备上创建rootfs，并安装完整操作系统，因此，从体验上最接近完整系统。</p><p>没有root的机器，根据安卓不同版本，选择不同的软件。</p><ul><li>安卓5.0及以上，用Termux或UbuntuForAndroid</li><li>安卓4.4及以下，用GNURoot</li></ul><h2 id=termux>Termux</h2><p>由于文件系统无法遵循FHS规范，加上依赖的C库是bionic，所以不能直接拿其它发行版的二进制程序来用，需要单独编译。除了基础的库依赖/system/lib/下的libc.so、libm.so、libdl.so之外，其它动态库都在Termux的lib目录内，因此也可以说不是个自完备的系统。相比bionic的libc.so，glibc则命名为lib-2.32.so，再用libc.so.6软链接过去。</p><p>包管理器是dpkg和apt，又用shell封装了简单的pkg前端。初始化安装后有大约65个包，ca-certificates包只有一个文件，记录了可信任的CA，提供者是curl的作者，可见CA的基础性。在一次升级过程中遇到依赖的libandroid-support无法升级，甚至用<code>-o APT::Force-LoopBreak=yes install libxxx</code> 命令还导致所有程序全部被清空的惨剧。据说是用了改版的apt，使升级策略变成了滚动升级。重装之后提示仓库版本和本地不同，我选择D看差异却导致再也无法继续，只能再次重装时只敢选N(保留我的配置)，折腾3次才重新装上。</p><p>如果更换源，要先执行<code>apt-get update</code>更新缓存才能执行进一步操作。</p><p>默认bash，用chsh可以换sh，原理是把默认shell写入$HOME/.termux/shell。login不能作为默认shell。bash有700多K，而dash仅130K。bash提供了很多交互上方便的特性，典型的像通过改变PS1变量更换提示符，还有个内建钩子函数<code>command_not_found_handle</code>，当执行一个不存在的命令，会用一个外部程序给出更好的提示，比如用pkg安装某个对应包。</p><p>用atilo可以安装完整的linux，原理是先启动基于proot打了patch后的termux-chroot构造假的root环境，从lxc-images下载基础镜像，再以proot方式启动。包括取消LD_PRELOAD环境变量，用<code>env -i</code>加载空的环境，设置PROOT_NO_SECCOMP=1关闭可信计算。同时也说明这类镜像只依赖内核的syscall，辅以合适的根目录，就能运行。</p><p>在termux上编译软件要注意，因为默认的/usr/local路径不可用，必须用 ./configure &ndash;prefix=$PREFIX/stow/xx-1.0 方式显示指定安装路径。安装后，进入stow目录，执行stow xx-1.0就能用了，执行stow -D xx-1.0则删除该软件。</p><h2 id=ubuntuforandroid>UbuntuForAndroid</h2><p>自带ssh，装上就能用。源比debian要少太多，先安装software-properties-common再用add-apt-repository ppa:添加相应的源才能安装。在换国内源时遇到若干问题</p><ol><li>先确保安装了<em>ca-certificates</em></li><li>网上换源的文章都只适用于x86系，如果是arm的话，要把url的ubuntu换成ubuntu-ports</li><li>apt-get update会提示签名不通过，改成<code>deb [trusted=yes] http:...</code>。注意如果没有装第1步提到的包，即使加了trusted也没用</li></ol><h2 id=gnuroot>GNURoot</h2><p>可以安装debian jessie，理论上可以换源逐步升级到最新版本。不过在5.0不让装。</p><p>又试了Gentoo，依然遇到sshd问题。首先是没有公私钥对，用<code>ssh-keygen -t rsa -f ssh_host_rsa_key</code>生成，还是会断开，通过修改配置项<code>UsePrivilegeSeparation no</code>后能登陆。这个选项在7.5版本后废弃，强制yes，但在安卓系统下，可能是exec机制不同，必须no才能连接。如果sshd不管怎么配置都不能用，可以换dropbear，因为只用一个进程，免去了exec的麻烦。默认没有公钥的话，用dropbearkey -t rsa -f dropbear_rsa_host_key。由于Gentoo的portage机制导致小文过多，同步后直接把inode用完（至少13万个），导致系统无法使用。这可能也和手机版本4.2，默认只有19万inode，而另一台6.0上的inode有64万多，可惜无法尝试了。</p><p>由于ebuild不能用，只能源码编译，没有自带解压zip的软件，网上找到的unzip源码竟然是2010年最后更新的6.0版本，看起来也不会再更新了。支持非常多的操作系统，以致于根目录下没有Makefile，看了帮助才知道要自己从相应的目录复制Makefile，在那个操作系统百花齐放年代的软件，风格和如今大为不同。可能是太常用也太古老的关系，busybox也整合了unzip功能，倒不一定非得使用原始的unzip。顺便说下unzip和zip分属两个包，版本号也完全不同，有点难以想象。</p><p>应用市场能下载和GNURoot配套的镜像都比较旧，可用lxc制作的发行包(<a href=https://images.linuxcontainers.org/images/)>https://images.linuxcontainers.org/images/)</a>, arch或alpine也有独立发布的arm包(选armhf，不支持aarch64)。下载发行包后，按以下顺序操作</p><ol><li>进入/host-rootfs/data/data/champion.gnuroot/app_install目录，有roots/support/versions 共3个文件夹。versions不用管，在roots和support下创建同名文件，名字随便取以后会显示在下拉框。roots包含的是发行版的rootfs，support是proot和busybox。由此看出GNURoot的流程大概就是busybox内用proot加载rootfs，达到模拟操作系统的目的。</li><li>创建host-rootfs目录，如果没有/etc/resolv.conf也复制一份。</li></ol><p>做完以上两步，再打开GNURoot的下拉框，就可以看到刚安装的发行版了。</p><ul><li>不成功案例1: 先安装GNURoot的aboriginal包，然后不另建目录，直接把发行版的rootfs覆盖上去，再次打开会退出，可见必须另建新目录。在覆盖时遇到一个有趣的问题，原有的bin/目录是指向usr/bin/的软链接，这时一定要用<code>rm -rf bin</code>，<em>不可以在bin后面加/</em>，否则会把指向的目录删掉。因为软链接是文件，不加末尾的/，rm只删除这个软链，而加了/的话，会被作为目录删除导致悲剧。</li><li>不成功案例2: 在安卓5上可以安装GNURoot，但安装dropbear后，ssh输入密码成功后，提示<code>client_loop: send disconnect: Broken pipe</code>，然后断开。可见终究还是不能用。</li></ul><h2 id=gnuroot-debian-jessie>GNURoot Debian Jessie</h2><p>可以逐个版本地滚动升级上来</p><pre tabindex=0><code>apt-get update
apt-get upgrade
apt-get dist-upgrade
sed -i &#39;s/jessie/stretch/g&#39; /etc/apt/sources.list
</code></pre><p>之后再重复以上3升级步骤，此时要多一条</p><pre tabindex=0><code>apt-get autoremove
</code></pre><p>这样就彻底向上跳了一个版本，后续版本的更新类似。不过在一台未root的手机上操作，最终却因为libc无法更新停在了half-install状态，此时尝试装file，会提示需要libc >= 1.20，但是jessie的版本是1.19，只有stretch是1.24，无法安装新的软件，导致这个版本等于是废了。</p></div><div class="post-meta meta-tags">没有标签</div></article></div><footer id=footer><div>&copy; 2022 <a href>蛙二的思考 By</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=/post/220421/ title=数据引擎和算子对比>数据引擎和算子对比</a></li><li><a href=/post/220405/ title=Kubernetes初学笔记>Kubernetes初学笔记</a></li><li><a href=/post/220312/ title=分布式计算在Spark上的实现>分布式计算在Spark上的实现</a></li><li><a href=/post/220204/ title=分布式哈希技术摘录>分布式哈希技术摘录</a></li><li><a href=/post/220201/ title=压缩技术浅谈>压缩技术浅谈</a></li><li><a href=/post/220115/ title=Python的数据科学相关库介绍>Python的数据科学相关库介绍</a></li><li><a href=/post/211226/ title=SU的执行过程与用户登陆机制>SU的执行过程与用户登陆机制</a></li><li><a href=/post/211222/ title=SQL的JOIN种类与选择>SQL的JOIN种类与选择</a></li><li><a href=/post/211218/ title=内存使用的观察和理解>内存使用的观察和理解</a></li><li><a href=/post/211115/ title=搭建最小化的Linux系统>搭建最小化的Linux系统</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>