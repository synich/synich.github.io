<!doctype html><html lang=zh-ch>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Linux上的虚拟化 | 蛙二的思考</title>
<meta property="og:title" content="Linux上的虚拟化 - 蛙二的思考">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-07-03T12:00:00+08:00">
<meta property="article:modified_time" content="2019-07-03T12:00:00+08:00">
<meta name=Keywords content>
<meta name=description content="Linux上的虚拟化">
<meta name=author content>
<meta property="og:url" content="/post/190703/">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href>
蛙二的思考
</a>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href>首页</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>Linux上的虚拟化</h1>
</header>
<date class="post-meta meta-date">
2019年7月3日
</date>
<div class=post-content>
<h2 id=容器化>容器化</h2>
<p>为了实现弹性计算和灵活迁移，把一台机器跑出尽可能多的实例，且实例间做到隔离，容器化相比虚拟机，省去了kernel的模拟，没有驱动方面的困扰，启动也更快。由于不能更换kernel，容器环境很可能没有/boot/目录(取决于chroot时有没有屏蔽)，容器环境的rootfs会额外挂载，比如在debian上启动cent的环境。</p>
<p>容器化通过四个主要组件工作：名称空间（namespaces），控制组（cgroups），映像（images）和用户空间工具例如Docker或Podman。它们都基于内核的namespace，cgroup，unionFS机制，剩下的images和用户空间工具为了更好的封装。</p>
<h2 id=namespace>namespace</h2>
<p>namespace有多种类型 (mnt, net, ipc, user, pid, uts, cgroup, time)，没有namespace之前，所有<code>task_struct</code>共享一些全局属性，引入namespace特性后，task结构中增加了struct nsproxy *nsproxy;指针，以下是稍早期版本的结构体，没有user和time两种类型。</p>
<pre tabindex=0><code>struct nsproxy {
  atomic_t count;
  struct uts_namespace *uts_ns;
  struct ipc_namespace *ipc_ns;
  struct mnt_namespace *mnt_ns;
  struct pid_namespace *pid_ns_for_children;
  struct net       *net_ns;
  struct cgroup_namespace *cgroup_ns;
};
</code></pre><p>这些变量在/proc/pid/ns/目录下都有对应的文件。</p>
<p>uts来源于uname(2)依赖的结构体 struct utsname，而这个结构体的名字源自于"UNIX Time-sharing System"。似乎只影响hostname和domainname。</p>
<p>网络namespace包括网卡，回环设备，路由表，iptables规则。</p>
<p>总的来说，namespace的本质就是把原来所有进程全局共享的资源拆分成了很多个一组一组进程共享的资源</p>
<ul>
<li>当一个namespace里面的所有进程都退出时，namespace也会被销毁，所以抛开进程谈namespace没有意义</li>
<li>UTS namespace就是进程的一个属性，属性值相同的一组进程就属于同一个namespace，跟这组进程之间有没有亲戚关系无关</li>
<li>clone和unshare都有创建并加入新的namespace的功能，他们的主要区别是：</li>
</ul>
<blockquote>
<p>unshare是使当前进程加入新创建的namespace</p>
</blockquote>
<blockquote>
<p>clone是创建一个新的子进程，然后让子进程加入新的namespace</p>
</blockquote>
<ul>
<li>UTS namespace没有嵌套关系，即不存在说一个namespace是另一个namespace的父namespace</li>
</ul>
<h2 id=cgroup>cgroup</h2>
<p>google工程师为了解决系统资源无法隔离的问题，于2006年提出此方案，并最终合并到2.6内核。</p>
<p>物理机或虚拟机享有全部的资源，查看 /proc/[pid]/cgroup 列出的内容没有值，而容器的话会随着不同的实现方式输出不同，有kubepods/docker/machine-rkt等多种。利用这个特性，也可以检测到是否在容器环境。</p>
<h2 id=unionfs>unionFS</h2>
<p>把不同的目录的内容，联合放到同一目录内（如果有同名文件，只会看到一个）。在原始目录的修改会影响到unionFS中，反之不会。严格讲不能算虚拟化技术，但这个特性对于容器很有价值。</p>
<h2 id=qemu虚拟机>QEMU虚拟机</h2>
<p>过程是将目标机的体系翻译成中间语言，再将中间语言翻译成宿主机的过程。主启动程序是qemu-system-xxx，支持x86、arm、mips等多种架构，不同架构有不同的执行程序。虽然都是一套软件，但支持力度却不同，X86(包括X64)最方便，只要配置好硬盘和内存参数就可以启动，而arm就要-M指定模拟的机器，-bios指定启动器（甚至还要自己上网找bios），这和arm只规定指令集，不包含外围引导也有关系。</p>
<p>QEMU是纯软实现，不会利用硬件本身的虚拟化特性，速度非常慢。但支持-enable-kvm加速，可惜我用的是手机，无法体验kvm的效果。</p>
<p>arm版本启动后，无法进入引导，可能是bios没有选择正确。默认会开vnc，但对arm版来说，只会进入qemu的控制台，没什么用。相反x64的问题就少很多。但x64也存在只认某些ISO镜像的问题。</p>
<p>除了虚拟机执行器本身，还有些外围程序，最常用的是qemu-image，用于创建、查看、管理虚拟机镜像。推荐用qcow2格式的镜像，支持把其它虚拟机的镜像格式转换，还能查看已有镜像的大小和其它属性。</p>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href>蛙二的思考 By </a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=/post/211218/ title=内存使用的观察和理解>内存使用的观察和理解</a>
</li>
<li>
<a href=/post/211115/ title=搭建最小化的Linux系统>搭建最小化的Linux系统</a>
</li>
<li>
<a href=/post/211102/ title=几种语言的包加载和管理机制>几种语言的包加载和管理机制</a>
</li>
<li>
<a href=/post/211016/ title=以太和IP网之外的一些网络>以太和IP网之外的一些网络</a>
</li>
<li>
<a href=/post/210901/ title=对昼伏夜出和朝九晚五两个技战法的分析>对昼伏夜出和朝九晚五两个技战法的分析</a>
</li>
<li>
<a href=/post/210729/ title=git的远程访问辨析>git的远程访问辨析</a>
</li>
<li>
<a href=/post/210721/ title=PySpark分析>PySpark分析</a>
</li>
<li>
<a href=/post/210614/ title=erlang和其上的扩展语言>erlang和其上的扩展语言</a>
</li>
<li>
<a href=/post/210613/ title=lisp编程与结构化思想>lisp编程与结构化思想</a>
</li>
<li>
<a href=/post/210611/ title=理解shell的换行和打印>理解shell的换行和打印</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
</div>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>