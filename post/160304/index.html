<!doctype html><html lang=zh-ch><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Openresty代码初读 | 蛙二的思考</title><meta property="og:title" content="Openresty代码初读 - 蛙二的思考"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-03-04T12:00:00+08:00"><meta property="article:modified_time" content="2016-03-04T12:00:00+08:00"><meta name=Keywords content><meta name=description content="Openresty代码初读"><meta name=author content><meta property="og:url" content="/post/160304/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href>蛙二的思考</a></div><div><nav id=nav-menu class=clearfix><a class=current href>首页</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Openresty代码初读</h1></header><date class="post-meta meta-date">2016年3月4日</date><div class=post-content><p>我在公司内网的服务器从Apache httpd换成Openresty也有半年左右了，切换之后没有去深入研究，最近重新开始研究，一点初步的理解，记录在这里。</p><p>nginx给我最初的印象不是快或者节省资源，而是它居然的扩展机制。现在的软件都说自己是插件化体系，放个dll或so进去就可以增加功能，但nginx却需要每次重新编译，把扩展代码和执行程序编在一起才行。好像淘宝有个Tengine的扩展，可以用动态库的方式扩展，不过openresty没有用，那就还是看nginx的代码好了。</p><p>openresty的编译也是用configure脚本，却不是用GNU的auto系，而是在平级目录下有个auto目录，里面有各式各样的脚本检测OS或编译器选项，这块不清楚是不是个独立的项目，又或者是作者自己手工写的。</p><p>nginx编译添加模块的方式是在./configure后面用&ndash;add-module=指定路径方式，从configure脚本可以看到，是在指定目录下寻找config文件，如果有再从config文件读入相应的源代码和模块名信息。config定法也不复杂，就定义一些shell变量，然后统一被写入编译文件列表。nginx内一个很重要的概念是模块，代码中是个名为ngx_module_t的结构体，官方提供的http和mail功能是用模块，扩展功能也是同样实现这个模块。在core目录下，可以找到<code>extern ngx_module_t *ngx_modules[];</code>这样一句声明，而在main函数中就直接循环遍历这个数组了。找遍nginx目录也没有找到这个变量定义的地方，再结合每次扩展需要重新编译，恍然大悟去编译目录objs/下果然找到<code>ngx_modules.c</code>这个文件，里面赫然定义了<code>ngx_module_t *ngx_modules[] = {</code>以及之后的若干个模块，之就是nginx静态编译扩展的原理了。模块分了CORE、CONF、HTTP和MAIL四个大类但定义是分散在core/http/mail三个目录下，似乎除了CORE会用于逻辑判断，其它几个并没有严格地规定。模块版本号目前都是1，也没有做逻辑判断，可能是为了将来扩展吧。另外模块中真正起作用的，就是content指针和7个函数指针。不过有些扩展模块并未实现函数指针，只有content是必须实现。或许是因为大多数模块并不需要参与nginx的核心调度，只要有content环境能和核心进行交互即可。像openresty中非常重要的lua扩展，也只不过实现了7个函数指针中的<code>init_process</code>这一个函数。</p><p>由于模块是编译进程序，运行自然也就和nginx在同一个地址空间，遍观如今排名前20的主流语言，体积小功能完整的，还真就只有lua了。因为扩展是直接在nginx的worker进程跑，如果扩展出点问题，worker进程是会直接挂掉的，开始我不知道，用ngx.say去遍历打印ngx内部的成员名和类型，结果浏览器就没有结果显示，后来看了代码才发现，因为table中有ngx.say不支持的类型值，结果lua扩展直接触发了abort();这个问题后续还是要注意，如果nginx中要执行长会话动作，这种abort还是很危险的。</p></div><div class="post-meta meta-tags">没有标签</div></article></div><footer id=footer><div>&copy; 2022 <a href>蛙二的思考 By</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=/post/220421/ title=数据引擎和算子对比>数据引擎和算子对比</a></li><li><a href=/post/220405/ title=Kubernetes初学笔记>Kubernetes初学笔记</a></li><li><a href=/post/220312/ title=分布式计算在Spark上的实现>分布式计算在Spark上的实现</a></li><li><a href=/post/220204/ title=分布式哈希技术摘录>分布式哈希技术摘录</a></li><li><a href=/post/220201/ title=压缩技术浅谈>压缩技术浅谈</a></li><li><a href=/post/220115/ title=Python的数据科学相关库介绍>Python的数据科学相关库介绍</a></li><li><a href=/post/211226/ title=SU的执行过程与用户登陆机制>SU的执行过程与用户登陆机制</a></li><li><a href=/post/211222/ title=SQL的JOIN种类与选择>SQL的JOIN种类与选择</a></li><li><a href=/post/211218/ title=内存使用的观察和理解>内存使用的观察和理解</a></li><li><a href=/post/211115/ title=搭建最小化的Linux系统>搭建最小化的Linux系统</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>