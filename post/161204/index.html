<!doctype html>
<html lang="zh-ch">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>FastCGI协议及PHP中的相关部分 | 蛙二的思考</title>
    <meta property="og:title" content="FastCGI协议及PHP中的相关部分 - 蛙二的思考">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2016-12-04T12:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2016-12-04T12:00:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="FastCGI协议及PHP中的相关部分">
        
    <meta name="author" content="">
    <meta property="og:url" content="/post/161204/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="">
                        蛙二的思考
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="">首页</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">FastCGI协议及PHP中的相关部分</h1>
        </header>
        <date class="post-meta meta-date">
            2016年12月4日
        </date>
        
        
        
        <div class="post-content">
            <p>FastCGI作为解决CGI协议的后继者，已深得人心，在Nginx和PHP中都默认支持。
比如php-cgi虽然名字是cgi，但是-b模式开启的其实是FastCGI模式。
再配合上Nginx的<code>fastcgi_pass</code>指令，动态网页的环境就完成了。</p>
<p>CGI使用环境变量和stdin/stdout来传输数据，FastCGI是网络化的，
因此有协议规范，协议为8字节对齐，头是个8字节的标志位：</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>这个格式缺少协议头标志(MagicFlag)，大概那个时代都是如此吧。
版本好像只有1，type是消息类型共有10种：</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>比较常见的有<code>BEGIN_REQUEST</code>/<code>END_REQUEST</code>(网络化后标识请求应答状态用)，
PARAMS(代替环境变量)，STDIN/STDOUT(名字和CGI一样，含义则作了泛化)。</p>
<p>BEGIN/END的payload部分是定长的，BEGIN定义</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>role表示Web服务器期望应用扮演的角色。分为三个角色</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>flags包含一个控制线路关闭的位：FCGI_KEEP_CONN：
如果为0，则应用在对本次请求响应后关闭线路。
如果非0，应用在对本次请求响应后不会关闭线路。一般都是非0，减少连接开销。</p>
<p>END定义：</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>appStatus是应用级别的状态码。protocolStatus组件是协议级别的状态码；
protocolStatus的值可能是：</p>
<ul>
<li><code>FCGI_REQUEST_COMPLETE</code>：请求的正常结束。</li>
<li><code>FCGI_CANT_MPX_CONN</code>：拒绝新请求。这发生在Web服务器通过一条线路向应用发送并发的请求时，后者被设计为每条线路每次处理一个请求。</li>
<li><code>FCGI_OVERLOADED</code>：拒绝新请求。这发生在应用用完某些资源时，例如数据库连接。</li>
<li><code>FCGI_UNKNOWN_ROLE</code>：拒绝新请求。这发生在Web服务器指定了一个应用不能识别的角色时。</li>
</ul>
<p>另外PARAMS、STDIN/STDOUT由于受协议单次数量64K的限制，如果要分包，
则采用最后带一个长度为0的请求表示结束。有点类似HTTP的CHUNK传输方式。</p>
<p>详细说下chunked方式，回复的HTTP包头如果标识是chunked方式，包头结束后(即单独的一个空行<code>\r\n</code>)，接下来就是若干个chunk，格式遵循这个格式：该chunk的字节长度加上回车，然后是正文数据加上一个回车结束。</p>
<p>比如发送abcd四个字节，这个chunk是<code>34 0d 0a 61 62 63 64 0d 0a</code>，34和回车表示这个块有4字节，正文数据的长度匹配后再跟一个回车，当所有带内容的chunk都结束后，要再发送一个结束包<code>30 0d 0a 0d 0a</code>，30和回车表示块有0个字节，这个不存在的正文后再跟一个回车，内容结束。长度按16进制表示，比如一个附件是44307字节，抓包是<code>61 64 31 33 0d 0a</code>，表示ad13，转成十进制正好是44307。</p>

        </div>

        


        


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    

    
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="">蛙二的思考 By </a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>







                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="/post/210901/" title="对昼伏夜出和朝九晚五两个技战法的分析">对昼伏夜出和朝九晚五两个技战法的分析</a>
    </li>
    
    <li>
        <a href="/post/210729/" title="git的远程访问辨析">git的远程访问辨析</a>
    </li>
    
    <li>
        <a href="/post/210721/" title="PySpark分析">PySpark分析</a>
    </li>
    
    <li>
        <a href="/post/210614/" title="erlang和其上的扩展语言">erlang和其上的扩展语言</a>
    </li>
    
    <li>
        <a href="/post/210613/" title="lisp编程与结构化思想">lisp编程与结构化思想</a>
    </li>
    
    <li>
        <a href="/post/210611/" title="理解shell的换行和打印">理解shell的换行和打印</a>
    </li>
    
    <li>
        <a href="/post/210421/" title="vim的自定义扩展">vim的自定义扩展</a>
    </li>
    
    <li>
        <a href="/post/210404/" title="数据库的执行优化">数据库的执行优化</a>
    </li>
    
    <li>
        <a href="/post/210322/" title="对公有云上数仓的调研">对公有云上数仓的调研</a>
    </li>
    
    <li>
        <a href="/post/210216/" title="hadoop体系理解">hadoop体系理解</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>