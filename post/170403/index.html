<!doctype html><html lang=zh-ch><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>php-fpm记录 | 蛙二的思考</title><meta property="og:title" content="php-fpm记录 - 蛙二的思考"><meta property="og:type" content="article"><meta property="article:published_time" content="2017-04-03T12:00:00+08:00"><meta property="article:modified_time" content="2017-04-03T12:00:00+08:00"><meta name=Keywords content><meta name=description content="php-fpm记录"><meta name=author content><meta property="og:url" content="/post/170403/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href>蛙二的思考</a></div><div><nav id=nav-menu class=clearfix><a class=current href>首页</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>php-fpm记录</h1></header><date class="post-meta meta-date">2017年4月3日</date><div class=post-content><p>PHP的组成，从内到外大致分3层</p><ol><li>解析器核心，在形态上表现成php.dll方式，实质是zend引擎，做语法解析和字节码执行。对应配置php.ini</li><li>函数和标准库</li><li>外覆层，引出SAPI概念，进入解析器的入口可以有多种模式，这些模式就称为SAPI。比如php-fpm，对应配置php-fpm.conf</li></ol><p>写web程序时，可以很方便地调用<code>$_GET</code>，这个变量不是核心层的特性，而是在SAPI层解析了CGI环境变量后，再传给核心的。所以不同的SAPI，会提供不同的外围特性。</p><p>比如在linux下默认编译出的有php(cli)、php-cgi(cgi)和phpdbg(dbg)这3个可执行程序，如果要配合nginx，在编译选项增加<code>--enable-fpm</code>就能得到php-fpm(fpm)。它们都能解析PHP，PHP-FPM存放在/usr/sbin/下，其它几个则在/usr/bin/下。但是不知为何linux并没有用动态库，上述4个程序都是静态编译，每个29M，这样做很浪费空间，也许是我编译选项没有打开？逐个说明这几种SAPI：</p><ul><li>cli : 命令行接口，也是其它语言最常见的模式，像python/ruby等程序都可以理解为cli模式。</li><li>debug : 调试接口，和<code>perl -d</code>方式效果相同(也许其它语言也有类似的)。这个接口似乎是5.6或稍早的版本被合进主干的。</li><li>cgi : 这个接口就体现PHP天生为Web语言的一面了，支持CGI协议规范，相当于在PHP的语言内核外，增加了对CGI请求的支持，在windows版的phpstudy默认就是运行4个<code>php-cgi</code>进程常驻后台。</li><li>fpm : 最初好像只是个进程管理器，后来也支持CGI解析。大约在5的时代被合入主干。是目前的主流的FastCGI容器方案，似乎只能运行在<code>*nix</code>上。</li></ul><p>由于php-fpm只是外围入口，很多php自身的参数仍然需要设置，所以它有两个配置选项，-c指定php.ini路径，-y指定fpm路径。重启使用kill -USR2 PID方式，关闭使用-INT。如果要快速找到pid可以打开配置中定义的pid文件路径，默认因为不保存所以要用ps加grep来查找。</p><p>要想加速php，少不了opcache模块，从5.5.3开始默认包含。它属于zend extensions，并且要指定完整so路径。原理是把编译后的PHP字节码缓存到内存，下次请求来的时候，根据文件名找到编译后的字节码，就能极大地节省时间。PHP对应cli模式，执行完毕就退出，显然这种模式无法利用缓存在内存的字节码，但不知为何7.1版本默认打开cli模式下的缓存。既然cli模式不行，通过PHP-FPM常驻内存，并fork多个子程序，子程序和父进程使用共享内存，子程序能完整地执行PHP字节码，并不依赖cli程序。一个佐证是Android上的phprunner程序中，就只有惟一的PHP-FPM程序配合lighttpd运行；而PHP Server这个包选择php和php-cgi程序，没有web服务器和php-fpm，靠php的web模式也能接收网络请求。</p><p>还要注意的一点，一旦打开缓存，所有的PHP的内容就都会用缓存的数据。我之前页面中的一些数据采用PHP的方式内嵌，导致缓存后无法更新，只有重启PHP进程才能更新数据，后来改成从txt文本读取才解决这个问题。</p></div><div class="post-meta meta-tags">没有标签</div></article></div><footer id=footer><div>&copy; 2022 <a href>蛙二的思考 By</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=/post/220421/ title=数据引擎和算子对比>数据引擎和算子对比</a></li><li><a href=/post/220405/ title=Kubernetes初学笔记>Kubernetes初学笔记</a></li><li><a href=/post/220312/ title=分布式计算在Spark上的实现>分布式计算在Spark上的实现</a></li><li><a href=/post/220204/ title=分布式哈希技术摘录>分布式哈希技术摘录</a></li><li><a href=/post/220201/ title=压缩技术浅谈>压缩技术浅谈</a></li><li><a href=/post/220115/ title=Python的数据科学相关库介绍>Python的数据科学相关库介绍</a></li><li><a href=/post/211226/ title=SU的执行过程与用户登陆机制>SU的执行过程与用户登陆机制</a></li><li><a href=/post/211222/ title=SQL的JOIN种类与选择>SQL的JOIN种类与选择</a></li><li><a href=/post/211218/ title=内存使用的观察和理解>内存使用的观察和理解</a></li><li><a href=/post/211115/ title=搭建最小化的Linux系统>搭建最小化的Linux系统</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>