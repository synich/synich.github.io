<!doctype html><html lang=zh-ch><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>数据库计算理论笔记 | 蛙二的思考</title><meta property="og:title" content="数据库计算理论笔记 - 蛙二的思考"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-03-27T12:00:00+08:00"><meta property="article:modified_time" content="2020-03-27T12:00:00+08:00"><meta name=Keywords content><meta name=description content="数据库计算理论笔记"><meta name=author content><meta property="og:url" content="/post/200327/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href>蛙二的思考</a></div><div><nav id=nav-menu class=clearfix><a class=current href>首页</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>数据库计算理论笔记</h1></header><date class="post-meta meta-date">2020年3月27日</date><div class=post-content><h2 id=事务和隔离级别>事务和隔离级别</h2><p>Jim Gray于1970最早提出事务的ACID特性，虽然它们并列为四大特性，但重要程度并不同。</p><ul><li>A 原子性，单机版已经很好地解决了这个问题，但分布式环境似乎仍然无解</li><li>C 一致性，只描述了最终的效果，过于宏大也没有提出具体的措施，因此更像是个衍生结论</li><li>I 隔离性，事务中最复杂的特性，分了多个隔离级别，较低的级别其实是在正确性上做了妥协，将异常结果抛给应用层解决，从而获得更好的性能</li><li>D 持久性，它的核心思想是应对系统故障，由此衍生出诸如WAL日志、日志同步/半同步、共享等多种具体技术</li></ul><p>可以说事务模型的发展过程就是隔离性和性能之间平衡的历史，甚至可以说隔离性是事务核心。</p><p>SQL92定义了4种隔离层级，不久后Jim Gray于1995年发表了经典论文《A Critique of ANSI SQL Isolation Levels》，正式提出了快照隔离的概念。同年Oracle很快就做出了回应，但它的First Update Win方案却不同于《批评》的First Commit Win方案。顺便说句PostgreSQL也和Oracle一样用了FUW方案。早期的MySQL存储引擎并不支持事务，InnoDB出现的时候，计划基于IBM的Aries算法做出MV2PL（多版本两阶段锁），但有学者在2009年基于此改造实现了快照隔离和串行快照隔离SSI，虽然如此但MySQL官方并不支持SI，只是做了可重复读RR。反倒是PG吸收了学界的成果，把SI和SSI合并到产品中。</p><p>SQL92之所以不提快照隔离并不是想不到，而是因为当时的实现主要基于锁并发，而快照隔离的基础是MVCC。当然到了现代，MVCC已经成了一种底层技术，用来高效实现乐观或悲观并发控制。乐观和悲观的区别就如字面意义，通过两段简单的代码来展示区别</p><p>乐观控制</p><pre tabindex=0><code>select * from goods where id = 1   -- 不加锁读
begin; -- 读之后开始事务
update goods set stock = stock - 1 where id = 1 and stock = cur_stock;  -- 更新时要注意 where 条件 “stock = cur_stock”，只有程序中获取到的库存量与数据库中的库存量相等才执行更新
commit;
</code></pre><p>悲观控制</p><pre tabindex=0><code>begin;  -- 先打开事务
select * from goods where id = 1 for update;  -- 读时用for update对数据加锁
update goods set stock = stock - 1 where id = 1;  -- 写时不再校验
commit;
</code></pre><p>可能是单机数据库的历史原因，也可能是应用层为了快速开发，占据主流还是悲观控制。</p><h2 id=一致性协议>一致性协议</h2><p>数据在多节点间的同步，应用较广的有这几种协议</p><ul><li>两阶段提交，即prepare和commit，要求所有节点都一致，高可用性不足</li><li>paxos/raft，中心化广播协议，前者是论文的提法，后者则是后来另一篇论文给出的几乎完整实现。可以看作是复制协议的一种，属于多数共识算法，大部分节点可用即通过</li><li>gossip协议，适用于P2P网络的同步协议，在节点非常多的时候，paxos负担会很重，这种场景用gossip更好</li></ul><h2 id=分布式>分布式</h2><p>CAP三者只能选其二，也可以只求一个达到最大化，没有见过实际例子。</p><ul><li>取CA，又名强一致性 ACID，但是分布式系统必然要求P，所以可以把ACID和传统单机的数据库等同</li><li>取AP，又名弱一致性 BASE，从命名中也能看出舍弃了C，在不追求严格准确（或者说始终最新）的场景有一定应用</li><li>取CP，用得最广，似乎没有专门的一致性定义</li></ul><p>CAP和ACID的C，中文都叫一致性，但两者含义稍有不同。CAP的C指多副本、单操作的一致性，而ACID的C，在最初的论文定义中是指单副本、多操作的事务一致性。</p><h2 id=数据分片>数据分片</h2><p>分片是单机分区机制在多副本的一种扩展，有两种</p><ul><li>Hash分片，为做到适应扩容，都会用一致性Hash算法。这种做法平衡性好，但业务不敏感，扫描时必须全副本都执行，归纳起来就是写性能出众，但读性能较差</li><li>Range分片，原生的分布式数据库多采用这种方案，多个分片间使用raft协议组成Group组，每个Group是最小的高可靠单元</li></ul><p>Sort和Shuffle是MapReduce上最核心的操作，由于MR每一步都会写磁盘，因此任意节点都能恢复，同样的，只要做足checkpoint也能非常健壮。</p></div><div class="post-meta meta-tags">没有标签</div></article></div><footer id=footer><div>&copy; 2022 <a href>蛙二的思考 By</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=/post/220421/ title=数据引擎和算子对比>数据引擎和算子对比</a></li><li><a href=/post/220405/ title=Kubernetes初学笔记>Kubernetes初学笔记</a></li><li><a href=/post/220312/ title=分布式计算在Spark上的实现>分布式计算在Spark上的实现</a></li><li><a href=/post/220204/ title=分布式哈希技术摘录>分布式哈希技术摘录</a></li><li><a href=/post/220201/ title=压缩技术浅谈>压缩技术浅谈</a></li><li><a href=/post/220115/ title=Python的数据科学相关库介绍>Python的数据科学相关库介绍</a></li><li><a href=/post/211226/ title=SU的执行过程与用户登陆机制>SU的执行过程与用户登陆机制</a></li><li><a href=/post/211222/ title=SQL的JOIN种类与选择>SQL的JOIN种类与选择</a></li><li><a href=/post/211218/ title=内存使用的观察和理解>内存使用的观察和理解</a></li><li><a href=/post/211115/ title=搭建最小化的Linux系统>搭建最小化的Linux系统</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>