<!doctype html><html lang=zh-ch>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Linux的权限与sudo辨析 | 蛙二的思考</title>
<meta property="og:title" content="Linux的权限与sudo辨析 - 蛙二的思考">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-02-05T12:00:00+08:00">
<meta property="article:modified_time" content="2021-02-05T12:00:00+08:00">
<meta name=Keywords content>
<meta name=description content="Linux的权限与sudo辨析">
<meta name=author content>
<meta property="og:url" content="/post/210205/">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href>
蛙二的思考
</a>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href>首页</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>Linux的权限与sudo辨析</h1>
</header>
<date class="post-meta meta-date">
2021年2月5日
</date>
<div class=post-content>
<h2 id=组>组</h2>
<p>id命令显示gid和groups输出，原因是每个用户只有一个初始组，但会加入多个组。当只有一个组时，这两个输出相同，加入多组就能看到区别。</p>
<p>组也有密码，但很少用，实际中多用sudo来完成权限管控。</p>
<h2 id=权限>权限</h2>
<p>linux的权限管控主要体现在两方面：</p>
<p>1、文件权限 2、进程权限</p>
<p>文件权限包括五种：</p>
<ul>
<li>r：可读取文件内容或目录结构</li>
<li>w：可修改文件的内容或目录的结构（但不包括删除）</li>
<li>x：文件可被系统执行或目录可被作文工作目录</li>
<li>s：文件在执行阶段具有文件所有者的权限</li>
<li>t：使一个目录既能够让任何用户写入文档，又不让用户删除这个目录下他人的文档</li>
</ul>
<p>一个文件拥有三组权限，所有者权限、所属组权限、其他人权限</p>
<p>进程权限</p>
<p>进程就是用户访问计算机资源的代理，用户执行的操作其实是带有用户身份信息的进程执行的操作。这里介绍两个最重要的进程权限id</p>
<p>reaal user id(ruid)：执行进程者的 user id，一般情况下就是用户登录时的 user id effective user id(euid)：决定进程是否对某个文件有操作权限，默认为ruid
在文件权限和进程权限id里，s文件权限和euid权限id是sudo实现提升权限的根本。一个进程是否能操作某个文件，取决于进程的euid是否拥有这个文件的相应权限，而不是ruid。也就是说，如果想要让进程获得某个用户的权限，只要把进程的euid设置为该用户id就可以了。在具体一点，我们想要让进程拥有root用户的权限，我只要想办法把进程的euid设置成root的id：0就可以了。</p>
<p>Linux提供了一个seteuid的函数，可以更改进程的euid。函数声明在头文件里。</p>
<p>int seteuid(uid_t euid);
但是，如果一个进程本身没有root权限，也就是说euid不是0，是无法通过调用seteuid将进程的权限提升的，调用seteuid会出现错误。 那该怎么把进程的euid该为root的id：0呢？那就是通过s权限。</p>
<p>如果一个文件拥有x权限，表示这个文件可以被执行。shell执行命令或程序的时候，先fork一个进程，再通过exec函数族执行这个命令或程序，这样的话，执行这个文件的进程的ruid和euid就是当前登入shell的用户id。</p>
<p>当这个文件拥有x权限和s权限时，在shell进行fork后调动exec函数族执行这个文件的时候，这个进程的euid将被系统更改为这个文件的拥有者id。</p>
<p>比如，一个文件的拥有者为user_1，权限为rwsr-xr-x，那么你用user_2的文件执行他的时候，执行这个文件的进程的ruid为user_2的id，euid为user_1的id。</p>
<p>创建一个main.c文件，并写入如下代码：</p>
<pre tabindex=0><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char* argv[])
{
        printf(&quot;ruid: %d\n&quot;,getuid());
        printf(&quot;euid: %d\n&quot;,geteuid());
        return 0;
}
</code></pre><p>运行结果如下：</p>
<pre tabindex=0><code>ruid: 1000
euid: 1000
</code></pre><p>通过chmod和chown为文件更改拥有者和添加s权限</p>
<pre tabindex=0><code>sudo chown root ./main
sudo chmod +s ./main
ruid: 1000 
euid: 0
</code></pre><p>此时由于文件的s权限，euid已经变为了root的id：0</p>
<p>将代码修改如下：</p>
<pre tabindex=0><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int maind(int argc, char* argv[])
{
    printf(&quot;ruid: %d\n&quot;,getuid());
    printf(&quot;euid: %d\n&quot;,geteuid());

    if(execvp(argv[1], argv+1) == -1){
        perror(&quot;execvp error&quot;);
    };
    return 0;
}
</code></pre><p>编译后执行</p>
<pre tabindex=0><code>sudo chown root ./main
sudo chmod +s ./main
./main apt update
</code></pre><p>可以看到，已经成功运行apt并进行了软件列表的更新。查看sudo的权限，就是一个拥有者为root且拥有s权限的可执行文件。</p>
<p>-rwsr-xr-x 1 root root</p>
<p>实际的sudo实现要比这复杂的很多，比如检查配置文件，来决定哪些用户可以使用sudo，为了安全考虑sudo还要求验证ruid的用户密码等。</p>
<h2 id=记录用户登陆行为有3个文件>记录用户登陆行为有3个文件</h2>
<ul>
<li>utmp: /var/run/utmp，记录当前正在登录系统的用户信息，默认由who和w记录当前登录用户的信息，uptime记录系统启动时间。u表示up</li>
<li>wtmp: /var/log/wtmp，记录当前正在登录和历史登录系统的用户信息，默认由last命令查看。w表示when</li>
<li>btmp: /var/log/btmp，记录失败的登录尝试信息，默认由lastb命令查看。b表示bad</li>
</ul>
<p>这3个命令据考证在1971年的Unix v1版本就出现了，当时文件记录在/tmp目录，所以这个有些随意的名字就一直沿用至今。文件是二进制格式，3个文件遵循相同的记录格式，解析参考/usr/include/utmp.h文件。</p>
<h2 id=文件隐藏权限>文件隐藏权限</h2>
<p>Operation not permitted，用lsattr查到有i权限，用chattr去掉后通过。也可能文件本身没有问题，但归属的目录有问题，用lsattr -a查看目录并操作。</p>
<p>文件属于e2fsprogs包。</p>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href>蛙二的思考 By </a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=/post/210901/ title=对昼伏夜出和朝九晚五两个技战法的分析>对昼伏夜出和朝九晚五两个技战法的分析</a>
</li>
<li>
<a href=/post/210729/ title=git的远程访问辨析>git的远程访问辨析</a>
</li>
<li>
<a href=/post/210721/ title=PySpark分析>PySpark分析</a>
</li>
<li>
<a href=/post/210614/ title=erlang和其上的扩展语言>erlang和其上的扩展语言</a>
</li>
<li>
<a href=/post/210613/ title=lisp编程与结构化思想>lisp编程与结构化思想</a>
</li>
<li>
<a href=/post/210611/ title=理解shell的换行和打印>理解shell的换行和打印</a>
</li>
<li>
<a href=/post/210421/ title=vim的自定义扩展>vim的自定义扩展</a>
</li>
<li>
<a href=/post/210404/ title=数据库的执行优化>数据库的执行优化</a>
</li>
<li>
<a href=/post/210322/ title=对公有云上数仓的调研>对公有云上数仓的调研</a>
</li>
<li>
<a href=/post/210216/ title=hadoop体系理解>hadoop体系理解</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
</div>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>