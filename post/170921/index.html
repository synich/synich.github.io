<!doctype html><html lang=zh-ch>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Lua中元表的理解 | 蛙二的思考</title>
<meta property="og:title" content="Lua中元表的理解 - 蛙二的思考">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-09-21T12:00:00+08:00">
<meta property="article:modified_time" content="2017-09-21T12:00:00+08:00">
<meta name=Keywords content>
<meta name=description content="Lua中元表的理解">
<meta name=author content>
<meta property="og:url" content="/post/170921/">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href>
蛙二的思考
</a>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href>首页</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>Lua中元表的理解</h1>
</header>
<date class="post-meta meta-date">
2017年9月21日
</date>
<div class=post-content>
<p>从题外话说起，Lua在语言虽然没有class关键字，但不妨碍它是一门OO的语言，只是归属到object-based这个类别下(JS是这个流派中的prototype-based一脉)。可以把Lua中所有的table变量认为是object，如果仅仅是这样肯定是不够的，让Lua产生变化的就是元表。</p>
<p>通过一个值的元表可以修改很多操作的含义，但我认为其中最有用的只有3个：<code>__index</code>(get)，<code>__newindex</code>(set)和<code>__call</code>，lua在选择关键字的时候没有太直观。一旦能覆写get/set操作，不仅仅数据得到了隐藏，还能实现delegation，使得语言看起来有了继承的特性，当然也提供了rawget/rawset来访问数据的本来面貌。call则让对象成了仿函，使函数式风格能实现。</p>
<p>在重写这些方法时，<code>__index</code>是两个固定参数，self和keyname，<code>__newindex</code>再多一个value。而<code>__call</code>的参数个数至少有一个self外加可变的参数列表&mldr;。共同点是重写函数的第一个参数都是self。</p>
<p>为什么一定会有self呢？因为这3个特殊索引的值都可以是函数，而且还是C风格的plain function。
像<code>__index</code>的触发条件至少有两个参数，因此像<code>__index</code>的实现，可以写成function mt:__index(name)这种风格。
如果朴素一点，就直接返回一个变量或新的table，绕弯一点也可以返回function，
进而构成链式调用。执行这个function会返回一个table，这个table要先做一次setmetatable，从而使外面使用者看来，就是一个完整可用的对象了。</p>
<p>又比如<code>__call</code>能让table当成函数来调用，如果这个table中含有的大量信息不传递到<code>__call</code>对应的函数就太可惜了，所以table就成了函数的第一个参数，这是从实用角度出发点得到的设计结果。</p>
<p>前面提到了rawget做点补充说明，正常情况从table访问元素如果访问不到(即值为nil)，就会触发元表机制，哪怕{b=nil}这种形式，访问b时也会查找元表，因为b用pairs根本看不到，所以rawget的结果通常就是nil。</p>
<p>再来一段例子说明元表设置时的一个小误区，看例子</p>
<p>我开始的设想，访问tbl[&lsquo;a&rsquo;]会得到inmeta，但事实是nil。通过chunkspy反汇编看到<code>__index=mt</code>这句对应的是getglobal指令，就是说在构造等号右边的表时，看不到左边的mt，所以尝试向global空间找，当然是找不到的，所以结果是nil。那么换一种写法：</p>
<p>似乎规避了刚才全局查找变量不存在的问题，好像也递归地把a设置到元表了，但是访问tbl.a时仍然是nil，说明<code>__index</code>的赋值是词法定界，即使看上去把mt重新赋值，但真正查找元素时还是用词法定界时的变量，所以还是老老实实地用<code>setmetatable({}, {__index=mt})</code></p>
<h2 id=弱引用>弱引用</h2>
<p>当想要引用一个对象，但是这个对象有自己的生命周期，不想介入这个对象的生命周期，这时候就是用弱引用。典型场景是cache，持有固然好，被释放也无关紧要。</p>
<p>将一对key, value放入到 WeakHashMap 里并不能避免该key值被GC回收，除非在 WeakHashMap 之外还有对该key的强引用。换句话说，只有cache的内容明确地被其他人需要，才会被保留，否则就被GC了。</p>
</div>
<div class="post-meta meta-tags">
没有标签
</div>
</article>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href>蛙二的思考 By </a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=/post/210901/ title=对昼伏夜出和朝九晚五两个技战法的分析>对昼伏夜出和朝九晚五两个技战法的分析</a>
</li>
<li>
<a href=/post/210729/ title=git的远程访问辨析>git的远程访问辨析</a>
</li>
<li>
<a href=/post/210721/ title=PySpark分析>PySpark分析</a>
</li>
<li>
<a href=/post/210614/ title=erlang和其上的扩展语言>erlang和其上的扩展语言</a>
</li>
<li>
<a href=/post/210613/ title=lisp编程与结构化思想>lisp编程与结构化思想</a>
</li>
<li>
<a href=/post/210611/ title=理解shell的换行和打印>理解shell的换行和打印</a>
</li>
<li>
<a href=/post/210421/ title=vim的自定义扩展>vim的自定义扩展</a>
</li>
<li>
<a href=/post/210404/ title=数据库的执行优化>数据库的执行优化</a>
</li>
<li>
<a href=/post/210322/ title=对公有云上数仓的调研>对公有云上数仓的调研</a>
</li>
<li>
<a href=/post/210216/ title=hadoop体系理解>hadoop体系理解</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
</div>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>