<!doctype html><html lang=zh-ch><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>AndroLua记录 | 蛙二的思考</title><meta property="og:title" content="AndroLua记录 - 蛙二的思考"><meta property="og:type" content="article"><meta property="article:published_time" content="2018-03-16T12:00:00+08:00"><meta property="article:modified_time" content="2018-03-16T12:00:00+08:00"><meta name=Keywords content><meta name=description content="AndroLua记录"><meta name=author content><meta property="og:url" content="/post/180316/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href>蛙二的思考</a></div><div><nav id=nav-menu class=clearfix><a class=current href>首页</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>AndroLua记录</h1></header><date class="post-meta meta-date">2018年3月16日</date><div class=post-content><p>一个在Android用lua开发程序的应用，利用了JNI技术。JNI的交互是在java中定义若干个native方式的接口，通过javah导出头文件。在C函数中实现这些导出头文件对应的函数。这是java调用C的流程。想从C调用java，就要借助传给C语言JNIEnv变量并保存下来，后续用这个变量找class和method，并通过JNIEnv来调用。利用lua、C、Java三者之间两两互通，最终实现lua和java的互操作。</p><p>最初的想法来自Lua的Kepler项目中luajava这个子项目。代码分为C和Java两部分，先看C语言部分。</p><p>1.1版本就luajava.c一个文件。前半部分定义了5个lua操作java对象的函数，new/newInstance/bindClass/createProxy/loadLib。4.0版本又增加了多个函数，为简化起见先学习这5个。</p><p>这5个函数肯定放入lua的table，并以字符串和C函数的关系绑定。这个L保存在CPtr.java定义的private long peer;成员变量。</p><p>lua中会以newuserdata方式创建JNIEnv类型变量，并命名为<code>__JNIEnv</code>保存到<code>LUA_REGISTRYINDEX</code>里。每当这个userdata被触发gc时，会找JNIEnv并用DeleteGlobalRef方式对jobject的引用计数减1。</p><p>luajava.c的后半部分定义了107个JNI的C实现，注册5个函数是在LuaState.java中定义为native方式的名为<code>luajava_open</code>的函数，由于javah的转换,到了C语言中函数名会稍有不同，但还是能看出来。C语言中实现了5大函数的注册。而在java的LuaState构造函数中，实现了<code>luajava_open</code>的调用。</p><p>如果是通过java的console方式，会在Console.java的main函数构造LuaState，实现5大函数在lua的注册，接下来就可以在lua中调用java了。</p><p>每次在abstract的JavaFunction调用LuaState.pushJavaFunction，就会在lua中创建新的userdata，再创建一个table，并设置<code>__call</code>域，执行函数调用int execute()签名函数。所有的入参在lua栈上，出参会压入栈上，返回的int就表示出参个数。</p><h2 id=开发安卓程序>开发安卓程序</h2><p>利用布局器交互式地添加几个简单的控件，.aly文件会依次出现这些控件，然后加上id=&ldquo;xx"之后，就可以在代码中操作这些控件。布局器只要一个LuaWebView，剩下的就是web开发和打包。</p></div><div class="post-meta meta-tags">没有标签</div></article></div><footer id=footer><div>&copy; 2022 <a href>蛙二的思考 By</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=/post/220421/ title=数据引擎和算子对比>数据引擎和算子对比</a></li><li><a href=/post/220405/ title=Kubernetes初学笔记>Kubernetes初学笔记</a></li><li><a href=/post/220312/ title=分布式计算在Spark上的实现>分布式计算在Spark上的实现</a></li><li><a href=/post/220204/ title=分布式哈希技术摘录>分布式哈希技术摘录</a></li><li><a href=/post/220201/ title=压缩技术浅谈>压缩技术浅谈</a></li><li><a href=/post/220115/ title=Python的数据科学相关库介绍>Python的数据科学相关库介绍</a></li><li><a href=/post/211226/ title=SU的执行过程与用户登陆机制>SU的执行过程与用户登陆机制</a></li><li><a href=/post/211222/ title=SQL的JOIN种类与选择>SQL的JOIN种类与选择</a></li><li><a href=/post/211218/ title=内存使用的观察和理解>内存使用的观察和理解</a></li><li><a href=/post/211115/ title=搭建最小化的Linux系统>搭建最小化的Linux系统</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>