<!doctype html>
<html lang="zh-ch">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>多进程与进程间通信 | 蛙二的思考</title>
    <meta property="og:title" content="多进程与进程间通信 - 蛙二的思考">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-08-30T12:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-08-30T12:00:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="多进程与进程间通信">
        
    <meta name="author" content="">
    <meta property="og:url" content="/post/200830/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="">
                        蛙二的思考
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="">首页</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">多进程与进程间通信</h1>
        </header>
        <date class="post-meta meta-date">
            2020年8月30日
        </date>
        
        
        
        <div class="post-content">
            <p>在linux中，fork和vfork的系统调用都是clone，当然标记是不同。</p>
<ul>
<li>fork: CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD</li>
<li>vfork: CLONE_VM|CLONE_VFORK</li>
<li>pthread_create: CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID</li>
</ul>
<p>以目前的性能优化而言，两者的开销区别并不大，更大的区别在于执行流程和内存空间不同。fork执行后，父子进程一定会被执行到，规范没有规定执行顺序，一般都是同时开始调度。而vfork则一定是子进程先执行，而且<strong>如果子进程没有调用_exit（不是exit）或exec函数的话，父进程不会被执行</strong>。</p>
<p>fork是COW，而vfork的子进程可以修改父进程的变量（纯share，没有copy），这也是为什么父进程必须等待子进程调用_exit后才会被执行的原因。</p>
<p>为什么要有僵尸状态呢？主要是因为父进程可能要取得子进程的退出状态等信息。僵尸状态是每一个进程必须要经过的过程（除init进程之外）。僵尸态只记录一个int状态，但不止一种信息，用wait.h的特殊宏可以解析出是exit还是stop，收到的信号量等 信息。但僵尸进程毕竟占用内核的pid资源，所以必须回收。</p>
<p>用strace观察锁，绝大多数都是futex函数调用，且操作都是FUTEX_WAIT_PRIVATE，很难看出区别，只有一次触发了FUTEX_WAIT。看资料说现在的锁实现，大多是先自旋一定次数，如果还获取不到，再用户态等待，不会轻易进入内核态，毕竟futex的目的就是防止程序进入内核态。子线程结束调用exit，而主线程结束调用exit_group。</p>
<p>创建线程的身份是tid，但由于操作系统的进程API在前，所以同一个主线程，不管创建多少子线程，这些子线程的pid都一样。</p>
<h2 id="进程会话和作业">进程会话和作业</h2>
<p>多个进程间会进行分组，有几种分组方式。</p>
<ul>
<li>session: 一般指shell session，一次登录sh导致的所有进程都在这个session下，而sh进程就称为session的领头进程，通过ps的SID列可以查到</li>
<li>job: 最典型用管道符串起来的多个进程，称为一次job。第一个进程是job的领头进程，通过ps的PGID列可以查到</li>
</ul>
<h2 id="7种进程间通信机制">7种进程间通信机制</h2>
<ol>
<li>pipe 管道，最简单，对应syscall有pipe和pipe2两种，pipe2多支持几种选项，是linux在2.6.27才加入的接口</li>
<li>fifo 有名管道，对应syscall是mknodat，因为有名，且对应磁盘上的文件，因此用mknod方式创建。</li>
<li>mmap 文件映射共享IO，速度最快（原理：在内存开辟一片缓冲区，把文件映射到内存上，你直接去操作内存就可以了）。shell中的管道符用的就是这种，但不管输入端的内容有多大，都只调用两次mmap（必须有MAP_SHARED标记），大小都是128K。</li>
<li>本地socket 最稳定</li>
<li>信号 携带信息量最小的</li>
<li>共享内存 开辟一块内存区域，大家都能访问，一个进程退出之后，这块内存还会给你保留下来，后来者还可以继续使用</li>
<li>消息队列</li>
</ol>
<h2 id="匿名管道">匿名管道</h2>
<p>先从匿名管道说起，在shell中执行 <code>ls | grep xx</code> 时，背后的流程是当前的sh为父进程，fork出两个子进程，分别exec执行ls和grep，而且这两个子进程之间会有匿名管道pipe()连接起来。由于两个子进程的父进程都是shell，因此存在亲缘关系，匿名管道以fd方式存在，通过fork方式被两个子进程共享，这就是匿名管道可以工作的原因。</p>
<p>顺便说一句，读管道要用read语句，而读命令行输入则是$#一系，由于输入形式的不同，处理逻辑也不同。</p>
<h2 id="有名管道">有名管道</h2>
<p>用读方式打开有名管道，默认是BLOCK模式，意味着当没有进程写入时，会一直堵塞。而一旦有数据写入，会源源不断地读到数据，即使没有数据写入，也不会阻塞读动作。因此对有名管道的读，每次读到空，就要关闭管道，并再次尝试打开，否则CPU会急剧升高。形如以下</p>
<pre tabindex="0"><code>while true {
    fd = open('fifo', 'r')
    line = fd.read()
    fd.close()
}
</code></pre><p>观察这两种管道的使用，会发现都使用<code>pipe_wait</code>系统调用，因此都叫管道。</p>
<p>匿名管道因为使用形式的关系，数据流动是单向的。而有名管道形式上是文件，当然是双向，打开用读写方式。而且有名管道涉及进程间交互，往往是双向流动。如果A到B，B直接打印到终端，人眼看上去没有区别，程序是无法捕获这段打印，有点类似内核输出报警，你能看到却没有任何方式拦截并重定向它。</p>
<p>引申一点，shell脚本中怎么判断是命令行启动，还是接在管道后？这两种情况下，stdin没有区分，这时就要再往前想一步，stdin这个逻辑概念指向谁？匿名管道模式，stdin指向的显然是管道，而命令行模式下，stdin指向的是终端，真实的终端叫tty，后来网络化后叫pts，但只是表示不同，终究有个对应的实体。tty命令就是打印stdin所对应的终端，如果stdin对应的是匿名管道，则会返回错误并提示<code>not a tty</code>。除了tty，用<code>[ -t 0 ]</code>也能判断0是否为tty。对应的C函数是isatty。</p>
<h2 id="文件锁">文件锁</h2>
<p>文件锁用flock保证一个进程启动时独占</p>

        </div>

        


        


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    

    
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="">蛙二的思考 By </a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">蛙二</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>







                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="/post/210901/" title="对昼伏夜出和朝九晚五两个技战法的分析">对昼伏夜出和朝九晚五两个技战法的分析</a>
    </li>
    
    <li>
        <a href="/post/210729/" title="git的远程访问辨析">git的远程访问辨析</a>
    </li>
    
    <li>
        <a href="/post/210721/" title="PySpark分析">PySpark分析</a>
    </li>
    
    <li>
        <a href="/post/210614/" title="erlang和其上的扩展语言">erlang和其上的扩展语言</a>
    </li>
    
    <li>
        <a href="/post/210613/" title="lisp编程与结构化思想">lisp编程与结构化思想</a>
    </li>
    
    <li>
        <a href="/post/210611/" title="理解shell的换行和打印">理解shell的换行和打印</a>
    </li>
    
    <li>
        <a href="/post/210421/" title="vim的自定义扩展">vim的自定义扩展</a>
    </li>
    
    <li>
        <a href="/post/210404/" title="数据库的执行优化">数据库的执行优化</a>
    </li>
    
    <li>
        <a href="/post/210322/" title="对公有云上数仓的调研">对公有云上数仓的调研</a>
    </li>
    
    <li>
        <a href="/post/210216/" title="hadoop体系理解">hadoop体系理解</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>